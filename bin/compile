#!/bin/bash

indent() {
  sed -u 's/^/       /'
}
cat_build_log() {
  local build_log=$HOME/.cpanm/build.log
  echo # empty line
  echo ----- dumping $build_log ----- | indent
  cat $build_log | indent
}

BUILD_DIR=$1
CACHE_DIR=$2

RELEASE_VERSION=5.22.0.0
PERL_PACKAGE=https://github.com/shoichikaji/relocatable-perl/releases/download/$RELEASE_VERSION/perl-x86_64-linux.tar.gz

echo $BUILD_DIR
echo $CACHE_DIR

rm -rf $BUILD_DIR/vendor
if [ -d $CACHE_DIR/vendor-$RELEASE_VERSION ]; then
  echo "-----> Vendoring Perl (using cache)"
  cp -a $CACHE_DIR/vendor-$RELEASE_VERSION $BUILD_DIR/vendor
else
  echo "-----> Vendoring Perl"
  mkdir -p $BUILD_DIR/vendor && curl -sSL $PERL_PACKAGE | tar xzf - --strip-components 1 -C $BUILD_DIR/vendor
fi

export PATH="$BUILD_DIR/vendor/bin:$PATH"

echo "Using perl `perl -e 'print $^V'`" | indent

cd $BUILD_DIR

if [ -f $BUILD_DIR/Makefile.PL ] || [ -f $BUILD_DIR/cpanfile ]; then
  echo "-----> Installing dependencies"
  VENDOR_DEPS="$BUILD_DIR/vendor/perl-deps"
  CACHE_DEPS="$CACHE_DIR/$PERL_VERSION/perl-deps"
  CPANM="perl -S $(which cpanm) -l $CACHE_DEPS"

  mkdir -p "$CACHE_DIR"
  $CPANM --notest --installdeps "$BUILD_DIR" 2>&1 | indent

  cp -R "$CACHE_DEPS" "$VENDOR_DEPS"

  echo "Dependencies installed" | indent
fi

echo "-----> Changing shebang lines"
change-shebang -f $BUILD_DIR/vendor/bin/* 2>&1 | indent

if [ -d $BUILD_DIR/vendor ]; then
  rm -rf $CACHE_DIR/vendor-$RELEASE_VERSION
  mkdir -p $CACHE_DIR
  cp -a $BUILD_DIR/vendor $CACHE_DIR/vendor-$RELEASE_VERSION
fi
