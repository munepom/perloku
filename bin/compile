#!/bin/bash

indent() {
  sed -u 's/^/       /'
}
cat_build_log() {
  local build_log=$HOME/.cpanm/build.log
  echo # empty line
  echo ----- dumping $build_log ----- | indent
  cat $build_log | indent
}

BUILD_DIR=$1
CACHE_DIR=$2

PERL_VERSION=5.22.0.0
PERL_PACKAGE=https://github.com/shoichikaji/relocatable-perl/releases/download/$PERL_VERSION/perl-x86_64-linux.tar.gz

VENDORED_PERL="$BUILD_DIR/vendor/perl"

echo $BUILD_DIR
echo $CACHE_DIR

rm -rf $BUILD_DIR/vendor
if [ -d $CACHE_DIR/vendor-$PERL_VERSION ]; then
  echo "-----> Vendoring Perl (using cache)"
  mkdir -p $VENDORED_PERL && cp -a $CACHE_DIR/vendor-$PERL_VERSION $VENDORED_PERL
else
  echo "-----> Vendoring Perl"
  mkdir -p $VENDORED_PERL && curl -sSL $PERL_PACKAGE | tar xzf - --strip-components 1 -C $VENDORED_PERL
fi

# Set up so we can use Perl right away
export PATH="$VENDORED_PERL/bin:$PATH"
export PERL5LIB="$VENDORED_PERL/lib/$PERL_VERSION:$VENDORED_PERL/lib/site_perl/$PERL_VERSION"

echo "Using perl `perl -e 'print $^V'`" | indent

cd $BUILD_DIR

if [ -f $BUILD_DIR/Makefile.PL ] || [ -f $BUILD_DIR/cpanfile ]; then
  echo "-----> Installing dependencies"
  VENDOR_DEPS="$BUILD_DIR/vendor/perl-deps"
  CACHE_DEPS="$CACHE_DIR/$PERL_VERSION/perl-deps"
  CPANM="perl -S $(which cpanm) -l $CACHE_DEPS"

  mkdir -p "$CACHE_DIR"
  $CPANM --notest --installdeps "$BUILD_DIR" 2>&1 | indent

  cp -R "$CACHE_DEPS" "$VENDOR_DEPS"

  echo "Dependencies installed" | indent
fi

if [ -d $BUILD_DIR/vendor ]; then
  rm -rf $CACHE_DIR/vendor-$PERL_VERSION
  mkdir -p $CACHE_DIR
  cp -a $BUILD_DIR/vendor $CACHE_DIR/vendor-$PERL_VERSION
fi
